<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daromad Link – Reklama tarmog‘i</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#4361ee; --success:#10b981; --danger:#ef4444; --gray:#64748b; --light:#f8fafc; --border:#e2e8f0; }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#1e293b;display:flex;align-items:center;justify-content:center;padding:20px;}
    .card{max-width:420px;width:100%;background:white;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.15);padding:40px 32px;text-align:center;transition:transform .3s;}
    .card:hover{transform:translateY(-5px);}
    h1{font-size:28px;margin-bottom:8px;color:var(--primary);}
    h2{font-size:22px;margin-bottom:16px;}
    p{color:var(--gray);line-height:1.6;margin-bottom:24px;}
    input{width:100%;padding:14px 16px;margin:10px 0;border:2px solid var(--border);border-radius:12px;font-size:16px;transition:.3s;}
    input:focus{outline:none;border-color:var(--primary);}
    button{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:.3s;margin:10px 0;}
    .btn-primary{background:var(--primary);color:white;}
    .btn-primary:hover{background:#3b56d0;}
    .btn-success{background:var(--success);color:white;}
    .btn-success:hover{background:#0d9b6f;}
    .btn-danger{background:var(--danger);color:white;}
    .link-box{background:#f1f5f9;padding:16px;border-radius:12px;font-family:monospace;font-size:14px;word-break:break-all;margin:20px 0;border:2px dashed #94a3b8;}
    .stats{display:flex;justify-content:space-around;margin:30px 0;padding:20px;background:#f8fafc;border-radius:16px;}
    .stat{text-align:center;}
    .stat-num{font-size:28px;font-weight:700;color:var(--primary);}
    .stat-label{font-size:14px;color:var(--gray);}
    .hidden{display:none !important;}
    .error{color:var(--danger);min-height:24px;margin-top:10px;font-weight:500;}
  </style>
</head>
<body>

<div class="card" id="landing">
  <h1>Daromad Link</h1>
  <p>Har 1000 ta bosish = <strong>$1</strong><br/>Faqat tanlangan nashriyotchilar uchun</p>
  <button class="btn-primary" id="showLoginBtn">Kirish</button>
</div>

<div class="card hidden" id="login">
  <h2>Kirish</h2>
  <input id="email" type="email" placeholder="pub1@daromad.uz" />
  <input id="pass" type="password" placeholder="Parol" />
  <button class="btn-primary" id="loginBtn">Kirish</button>
  <div class="error" id="error"></div>
</div>

<div class="card hidden" id="dash">
  <h2>Salom, <span id="userName"></span>!</h2>
  <p>Email: <strong id="email"></strong></p>
  <div class="link-box" id="link"></div>
  <button class="btn-success" id="copyBtn">Havolani nusxalash</button>

  <div class="stats">
    <div class="stat">
      <div class="stat-num" id="clicks">0</div>
      <div class="stat-label">Bosishlar</div>
    </div>
    <div class="stat">
      <div class="stat-num" id="earn">$0.00</div>
      <div class="stat-label">Daromad</div>
    </div>
  </div>

  <button class="btn-danger" id="logoutBtn">Chiqish</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDoHvJKLk_8QEm0nUN1fWi_lBtGq0nErdA",
  authDomain: "daromad-link.firebaseapp.com",
  projectId: "daromad-link",
  storageBucket: "daromad-link.firebasestorage.app",
  messagingSenderId: "770178829456",
  appId: "1:770178829456:web:00ee4ed46d4b4b6bb15c15"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const landing = document.getElementById('landing');
const loginDiv = document.getElementById('login');
const dash = document.getElementById('dash');
const errorEl = document.getElementById('error');

document.getElementById('showLoginBtn').addEventListener('click', () => {
  landing.classList.add('hidden');
  loginDiv.classList.remove('hidden');
});

document.getElementById('loginBtn').addEventListener('click', () => {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('pass').value;
  if (!email || !pass) {
    errorEl.textContent = "Iltimos, email va parolni kiriting";
    return;
  }
  errorEl.textContent = "Kirilmoqda...";
  auth.signInWithEmailAndPassword(email, pass)
    .catch(e => errorEl.textContent = e.message);
});

document.getElementById('copyBtn').addEventListener('click', () => {
  navigator.clipboard.writeText(document.getElementById('link').innerText);
  alert("Havola nusxalandi!");
});

document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

auth.onAuthStateChanged(async user => {
  // Har doim faqat bitta sahifa ko‘rinsin
  landing.classList.add('hidden');
  loginDiv.classList.add('hidden');
  dash.classList.add('hidden');
  errorEl.textContent = "";

  if (user) {
    dash.classList.remove('hidden');
    const name = user.email.split('@')[0];
    document.getElementById('userName').textContent = name;
    document.getElementById('email').textContent = user.email;

    const pubRef = db.collection("publishers").doc(user.uid);

    // MUHIM: Faqat birinchi marta hujjat yaratamiz
    const docSnap = await pubRef.get();
    if (!docSnap.exists) {
      await pubRef.set({
        clicks: 0,
        earnings: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    // Havola
    document.getElementById('link').textContent = `${location.origin}/${name}click.html`;

    // Real-time statistika (refreshda 0 bo‘lmaydi!)
    pubRef.onSnapshot(doc => {
      const data = doc.data();
      if (data) {
        document.getElementById('clicks').textContent = data.clicks || 0;
        document.getElementById('earn').textContent = "$" + (data.earnings || 0).toFixed(2);
      }
    });

  } else {
    landing.classList.remove('hidden');
  }
});
</script>
</body>
</html>

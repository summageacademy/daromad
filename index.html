<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daromad Link – Professional Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{--p:#4361ee;--s:#10b981;--d:#ef4444;--g:#64748b;--b:#1e293b;--l:#f8fafc;--grad:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Inter',sans-serif;background:var(--grad);min-height:100vh;color:#fff;padding:20px;}
    .container{max-width:500px;margin:0 auto;}
    .card{background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:24px;padding:32px;box-shadow:0 20px 40px rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);}
    h1{font-size:32px;text-align:center;margin-bottom:8px;}
    p{text-align:center;color:#ddd;margin-bottom:24px;}
    input,button{width:100%;padding:16px;border-radius:16px;margin:10px 0;font-size:16px;}
    input{background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);color:white;}
    input:focus{outline:none;border-color:var(--p);}
    button{background:var(--p);color:white;border:none;font-weight:600;cursor:pointer;transition:0.3s;}
    button:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(67,97,238,0.4);}
    .btn-s{background:var(--s);}
    .btn-d{background:var(--d);}
    .link-box{background:rgba(0,0,0,0.2);padding:16px;border-radius:16px;font-family:monospace;font-size:15px;word-break:break-all;margin:20px 0;text-align:center;}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:24px 0;}
    .stat-box{background:rgba(255,255,255,0.1);padding:20px;border-radius:16px;text-align:center;}
    .stat-num{font-size:28px;font-weight:700;}
    canvas{margin:20px 0;border-radius:16px;}
    .hidden{display:none !important;}
    .error{color:#ff6b6b;margin-top:10px;}
    .dark-toggle{position:fixed;top:20px;right:20px;font-size:24px;cursor:pointer;z-index:999;}
  </style>
</head>
<body>

<div class="dark-toggle" onclick="document.body.classList.toggle('dark')">Toggle Dark/Light</div>

<div class="container">

  <!-- Landing -->
  <div id="landing" class="card">
    <h1>Daromad Link</h1>
    <p>Har 1000 bosish = <strong>$1.00</strong><br>Professional reklama tarmog‘i</p>
    <button class="btn-s" id="showLoginBtn">Kirish</button>
  </div>

  <!-- Login -->
  <div id="login" class="card hidden">
    <h1 style="font-size:28px;">Kabinetga kirish</h1>
    <input id="email" type="email" placeholder="Email" />
    <input id="pass" type="password" placeholder="Parol" />
    <button id="loginBtn">Kirish</button>
    <div class="error" id="error"></div>
  </div>

  <!-- Dashboard -->
  <div id="dash" class="card hidden">
    <h1>Salom, <span id="userName"></span>!</h1>
    <p id="email"></p>

    <div class="link-box" id="link">Yuklanmoqda...</div>
    <button class="btn-s" id="copyBtn">Havolani nusxalash</button>

    <div class="stats-grid">
      <div class="stat-box"><div class="stat-num" id="clicks">0</div><div>Bosishlar</div></div>
      <div class="stat-box"><div class="stat-num" id="earn">$0.00</div><div>Daromad</div></div>
    </div>

    <canvas id="chart"></canvas>

    <button class="btn-s" id="payoutBtn">To‘lov so‘rash ($5+)</button>
    <button class="btn-d" id="logoutBtn">Chiqish</button>
  </div>
</div>

<script>
const firebaseConfig = {apiKey: "AIzaSyDoHvJKLk_8QEm0nUN1fWi_lBtGq0nErdA",authDomain: "daromad-link.firebaseapp.com",projectId: "daromad-link",storageBucket: "daromad-link.firebasestorage.app",messagingSenderId: "770178829456",appId: "1:770178829456:web:00ee4ed46d4b4b6bb15c15"};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let chart;

auth.onAuthStateChanged(async user => {
  document.getElementById('landing').classList.add('hidden');
  document.getElementById('login').classList.add('hidden');
  document.getElementById('dash').classList.add('hidden');

  if (user) {
    document.getElementById('dash').classList.remove('hidden');
    const name = user.email.split('@')[0];
    document.getElementById('userName').textContent = name;
    document.getElementById('email').textContent = user.email;

    const pubRef = db.collection("publishers").doc(user.uid);
    const snap = await pubRef.get();
    if (!snap.exists) {
      await pubRef.set({username: name, clicks:0, earnings:0, requests:[]});
    } else if (!snap.data().username) {
      await pubRef.update({username: name});
    }

    document.getElementById('link').textContent = location.origin + "/daromad/click.html?u=" + name;

    pubRef.onSnapshot(doc => {
      const d = doc.data();
      document.getElementById('clicks').textContent = (d.clicks || 0).toLocaleString();
      const earn = (d.earnings || 0).toFixed(2);
      document.getElementById('earn').textContent = "$" + earn;

      // Update chart
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('chart'), {
        type: 'line',
        data: {labels: ['Jan','Feb','Mar','Apr','May','Jun'], datasets: [{label: 'Daromad ($)', data: [0,0.5,1.2,2.8,4.1,parseFloat(earn)], borderColor: '#10b981', tension: 0.4, fill: true, backgroundColor: 'rgba(16,185,129,0.1)'}]},
        options: {responsive:true, plugins:{legend:{display:false}}}
      });
    });

    document.getElementById('payoutBtn').onclick = () => {
      const earn = parseFloat(document.getElementById('earn').textContent.replace('$',''));
      if (earn < 5) return alert("Minimum $5 to‘lov");
      if (confirm("To‘lov so‘raymizmi? ($" + earn.toFixed(2) + ")")) {
        pubRef.update({requests: firebase.firestore.FieldValue.arrayUnion({amount: earn, date: new Date(), status: "pending"})});
        alert("So‘rov yuborildi! Tez orada to‘laymiz.");
      }
    };

  } else {
    document.getElementById('landing').classList.remove('hidden');
  }
});

document.getElementById('showLoginBtn').onclick = () => {document.getElementById('landing').classList.add('hidden');document.getElementById('login').classList.remove('hidden');};
document.getElementById('loginBtn').onclick = () => {
  const e = document.getElementById('email').value.trim();
  const p = document.getElementById('pass').value;
  if (!e || !p) return document.getElementById('error').textContent = "To‘ldiring";
  auth.signInWithEmailAndPassword(e,p).catch(err=>document.getElementById('error').textContent=err.message);
};
document.getElementById('copyBtn').onclick = () => {navigator.clipboard.writeText(document.getElementById('link').textContent);alert("Nusxalandi!");};
document.getElementById('logoutBtn').onclick = () => auth.signOut();
</script>
</body>
</html>

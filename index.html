<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daromad Link | Pro Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --primary:#4361ee;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;
      --bg:#0f0f1a;--card:#1a1a2e;--border:#2d2d44;--text:#e2e8f0;--muted:#94a3b8;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;line-height:1.6;}

    /* AUTH */
    #authScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
    .auth-box{background:rgba(255,255,255,0.08);backdrop-filter:blur(20px);border-radius:24px;padding:48px 40px;width:100%;max-width:440px;box-shadow:0 25px 50px rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1);text-align:center;}
    .auth-box h1{font-size:36px;font-weight:800;color:white;margin-bottom:12px;}
    .auth-box p{font-size:18px;color:#ddd;margin-bottom:40px;}
    .input-group{margin:16px 0;}
    .input-group input{width:100%;padding:18px 20px;border-radius:16px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;font-size:16px;transition:0.3s;}
    .input-group input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(67,97,238,0.25);}
    button{width:100%;padding:18px;border-radius:16px;background:var(--primary);color:white;border:none;font-size:17px;font-weight:600;cursor:pointer;transition:0.3s;margin-top:10px;}
    button:hover{transform:translateY(-4px);box-shadow:0 15px 30px rgba(67,97,238,0.4);}
    button:disabled{background:#333;cursor:not-allowed;transform:none;box-shadow:none;}
    .error{color:#ff6b6b;margin-top:12px;font-size:14px;}

    /* APP LAYOUT */
    #app{display:none;height:100vh;flex-direction:column;}
    .layout{display:flex;height:100vh;}
    .sidebar{width:300px;background:var(--card);border-right:1px solid var(--border);padding:32px 24px;position:fixed;height:100%;left:0;top:0;z-index:998;overflow-y:auto;transition:left 0.3s;}
    .sidebar h2{font-size:26px;font-weight:800;color:var(--primary);text-align:center;margin-bottom:50px;}
    .nav-item{display:flex;align-items:center;gap:16px;padding:16px 20px;border-radius:16px;margin:8px 0;cursor:pointer;font-weight:500;transition:0.3s;}
    .nav-item:hover{background:rgba(67,97,238,0.15);}
    .nav-item.active{background:var(--primary);color:white;}
    .nav-item i{font-size:18px;width:24px;}
    .main-content{flex:1;margin-left:300px;padding:40px;overflow-y:auto;background:var(--bg);transition:margin-left 0.3s;}

    .page-title{font-size:28px;font-weight:700;margin-bottom:32px;color:white;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:28px;margin-bottom:40px;}
    .stat-card{background:var(--card);border-radius:20px;padding:32px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.3);border:1px solid var(--border);transition:0.3s;}
    .stat-card:hover{transform:translateY(-8px);}
    .stat-card h3{font-size:16px;color:var(--muted);margin-bottom:12px;}
    .stat-card .value{font-size:42px;font-weight:800;color:var(--success);}
    .link-card{background:var(--card);border-radius:20px;padding:32px;box-shadow:0 10px 30px rgba(0,0,0,0.3);border:1px solid var(--border);}
    .link-box{background:#16213e;padding:20px;border-radius:16px;font-family:monospace;font-size:15px;margin:20px 0;word-break:break-all;text-align:center;color:#10b981;}
    .btn-primary{background:var(--primary);color:white;padding:14px 28px;border-radius:16px;border:none;font-weight:600;cursor:pointer;transition:0.3s;display:inline-block;}
    .btn-primary:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(67,97,238,0.4);}
    canvas{border-radius:16px;background:var(--card);padding:10px;}
    table{width:100%;border-collapse:collapse;margin-top:20px;font-size:15px;}
    th{background:var(--primary);color:white;padding:16px;text-align:left;}
    td{padding:16px;border-bottom:1px solid var(--border);}
    .copy-btn{background:#333;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;margin-left:8px;}

    .section{display:none;}
    .section.active{display:block;}

    /* HAMBURGER MENU */
    .hamburger{display:none;background:var(--primary);color:white;width:56px;height:56px;border-radius:50%;position:fixed;bottom:20px;right:20px;z-index:999;box-shadow:0 10px 30px rgba(67,97,238,0.5);font-size:24px;align-items:center;justify-content:center;cursor:pointer;}
    
    /* MOBILE */
    @media(max-width:992px){
      .sidebar{left:-300px;}
      .main-content{margin-left:0;padding:20px;padding-bottom:100px;}
      .hamburger{display:flex;}
      .sidebar.open{left:0;}
      .grid{grid-template-columns:1fr;gap:20px;}
      .page-title{font-size:24px;}
    }
  </style>
</head>
<body>

<!-- AUTH -->
<div id="authScreen">
  <div class="auth-box">
    <h1>Daromad Link</h1>
    <p>Har 1000 ta bosish = <strong style="color:#10b981;">$1.00</strong></p>
    <div class="input-group"><input id="email" type="email" placeholder="Email" /></div>
    <div class="input-group"><input id="pass" type="password" placeholder="Parol" /></div>
    <button id="loginBtn">Kirish</button>
    <div class="error" id="error"></div>
  </div>
</div>

<!-- APP -->
<div id="app" class="layout">
  <div class="sidebar">
    <h2>Daromad Link</h2>
    <div class="nav-item active" data-section="dashboard">Bosh sahifa</div>
    <div class="nav-item" data-section="stats">Statistika</div>
    <div class="nav-item" data-section="profile">Profil</div>
    <div class="nav-item" data-section="billing">To‘lovlar</div>
    <!-- ADMIN TAB — HIDDEN BY DEFAULT -->
    <div class="nav-item" id="adminTab" data-section="admin" style="display:none;">Admin Panel</div>
    <div class="nav-item" style="margin-top:auto;color:#ef4444;" onclick="auth.signOut()">Chiqish</div>
  </div>

  <div class="main-content">

    <!-- DASHBOARD -->
    <div id="dashboard" class="section active">
      <h1 class="page-title">Salom, <span id="userName">...</span>!</h1>
      <div class="grid">
        <div class="stat-card"><h3>Jami bosishlar</h3><div class="value" id="totalClicks">0</div></div>
        <div class="stat-card"><h3>Jami daromad</h3><div class="value" id="totalEarn">$0.00</div></div>
      </div>
      <div class="link-card">
        <h3>Sizning havola</h3>
        <div class="link-box" id="link">...</div>
        <button class="btn-primary" onclick="copyLink()">Nusxalash</button>
      </div>
    </div>

    <!-- STATS -->
    <div id="stats" class="section">
      <h1 class="page-title">Statistika</h1>
      <div class="grid">
        <div class="stat-card">
          <h3 style="text-align:center;margin-bottom:20px;">Oxirgi 7 kun</h3>
          <canvas id="dailyChart"></canvas>
        </div>
        <div class="stat-card">
          <h3 style="text-align:center;margin-bottom:20px;">Daromad o‘sishi</h3>
          <canvas id="earningsChart"></canvas>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="profile" class="section">
      <h1 class="page-title">Profil</h1>
      <div class="grid" style="max-width:600px;margin:0 auto;">
        <div class="stat-card">
          <p><strong>Email:</strong> <span id="profileEmail"></span></p>
          <p><strong>Username:</strong> <span id="profileUsername"></span></p>
          <p><strong>Ro‘yxatdan o‘tgan:</strong> <span id="joinedDate">-</span></p>
          <hr style="margin:30px 0;border:none;border-top:1px solid var(--border);">
          <h3>Karta raqami</h3>
          <input type="text" id="cardNumber" placeholder="8600 1234 5678 9012" maxlength="19" style="width:100%;padding:16px;border-radius:12px;background:#16213e;border:1px solid var(--border);color:white;margin:12px 0;" />
          <button class="btn-primary" onclick="saveCard()">Saqlash</button>
        </div>
      </div>
    </div>

    <!-- BILLING -->
    <div id="billing" class="section">
      <h1 class="page-title">To‘lovlar</h1>
      <div class="grid">
        <div class="stat-card">
          <h3>Balans</h3>
          <div class="value" id="balance">$0.00</div>
          <button class="btn-primary" id="requestPayout">So‘rash ($5+)</button>
          <p id="pendingNotice" style="margin-top:12px;color:#f59e0b;font-weight:600;display:none;">Sizda so‘rov bor. Kutilyapti...</p>
        </div>
      </div>
      <div class="stat-card">
        <h3>Tarix</h3>
        <table><thead><tr><th>Sana</th><th>Miqdor</th><th>Status</th></tr></thead><tbody id="payoutTable"></tbody></table>
      </div>
    </div>

    <!-- ADMIN PANEL — HIDDEN BY DEFAULT -->
    <div id="admin" class="section" style="display:none;">
      <h1 class="page-title">Admin Panel</h1>
      <div class="stat-card">
        <input type="text" placeholder="Qidiruv..." id="userSearch" onkeyup="filterUsers()" style="width:100%;padding:16px;border-radius:12px;background:#16213e;border:1px solid var(--border);color:white;margin-bottom:20px;" />
        <h3>Foydalanuvchilar</h3>
        <div style="overflow-x:auto;margin-bottom:30px;">
          <table><thead><tr><th>User</th><th>Karta</th><th>Bosish</th><th>Daromad</th><th>So‘rov</th><th>Amal</th></tr></thead><tbody id="usersBody"></tbody></table>
        </div>
        <h3>To‘lovlar tarixi</h3>
        <div style="overflow-x:auto;">
          <table><thead><tr><th>Sana</th><th>Foydalanuvchi</th><th>Miqdor</th><th>Karta</th></tr></thead><tbody id="adminPayoutLog"></tbody></table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- HAMBURGER -->
<div class="hamburger" onclick="document.querySelector('.sidebar').classList.toggle('open')">
  <i class="fas fa-bars"></i>
</div>

<script>
const firebaseConfig = {apiKey:"AIzaSyDoHvJKLk_8QEm0nUN1fWi_lBtGq0nErdA",authDomain:"daromad-link.firebaseapp.com",projectId:"daromad-link",storageBucket:"daromad-link.firebasestorage.app",messagingSenderId:"770178829456",appId:"1:770178829456:web:00ee4ed46d4b4b6bb15c15"};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let dailyChart, earningsChart;
let hasPendingRequest = false;

function showSection(id){
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  document.getElementById(id).style.display = 'block';
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelector(`[data-section="${id}"]`)?.classList.add('active');
}

function copyLink(){
  navigator.clipboard.writeText(document.getElementById('link').textContent);
  alert("Nusxalandi!");
}

async function saveCard(){
  let card = document.getElementById('cardNumber').value.replace(/\s/g,'');
  if(card && card.length !== 16) return alert("16 ta raqam kiriting");
  await db.collection("publishers").doc(auth.currentUser.uid).update({cardNumber: card || null});
  alert("Saqlandi!");
}

function loadAdminPanel(){
  document.getElementById('adminTab').style.display = 'flex';
  document.getElementById('admin').style.display = 'block';
  // Admin features here (same as before)
  db.collection("publishers").onSnapshot(snap => {
    const tbody = document.getElementById('usersBody');
    tbody.innerHTML = '';
    snap.docs.forEach(doc => {
      const d = doc.data();
      const pendingCount = (d.requests || []).filter(r => r.status === 'pending').length;
      const card = d.cardNumber ? d.cardNumber.replace(/(\d{4})/g, '$1 ').trim() : '—';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${d.username || '—'}</strong></td>
        <td>${card} ${d.cardNumber ? '<button class="copy-btn" onclick="navigator.clipboard.writeText(\''+d.cardNumber+'\')">Copy</button>' : ''}</td>
        <td>${(d.clicks||0).toLocaleString()}</td>
        <td>$${(d.earnings||0).toFixed(2)}</td>
        <td>${pendingCount}</td>
        <td>${pendingCount > 0 ? '<button class="btn-primary" style="padding:8px 16px;" onclick="payUser(\''+doc.id+'\')">To‘lash</button>' : '—'}</td>
      `;
      tbody.appendChild(tr);
    });
  });

  const logBody = document.getElementById('adminPayoutLog');
  db.collection("publishers").get().then(snap => {
    logBody.innerHTML = '';
    const payments = [];
    snap.docs.forEach(doc => {
      const d = doc.data();
      (d.requests || []).forEach(r => r.status === 'paid' && payments.push({date:r.date,username:d.username||'—',amount:r.amount,card:d.cardNumber?d.cardNumber.replace(/(\d{4})/g,'$1 ').trim():'—'}));
    });
    payments.sort((a,b)=> (b.date?.seconds || b.date) - (a.date?.seconds || a.date));
    payments.forEach(p => {
      const tr = document.createElement('tr');
      const date = new Date(p.date?.seconds*1000 || p.date);
      tr.innerHTML = `<td>${date.toLocaleDateString()}</td><td>${p.username}</td><td>$${p.amount.toFixed(2)}</td><td>${p.card}</td>`;
      logBody.appendChild(tr);
    });
    if(!payments.length) logBody.innerHTML = '<tr><td colspan="4">Hali to‘lov yo‘q</td></tr>';
  });
}

auth.onAuthStateChanged(async user => {
  if(!user){
    document.getElementById('app').style.display = 'none';
    document.getElementById('authScreen').style.display = 'flex';
    return;
  }
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';

  const pubRef = db.collection("publishers").doc(user.uid);
  const snap = await pubRef.get();
  let data = snap.data() || {};
  if(!snap.exists){
    data = {username:user.email.split('@')[0],clicks:0,earnings:0,requests:[],joined:new Date(),dailyStats:{},cardNumber:""};
    await pubRef.set(data);
  }

  const isAdmin = user.email === "abrorahmeed@gmail.com";
  if(isAdmin) loadAdminPanel();

  const username = data.username || user.email.split('@')[0];
  document.querySelectorAll('#userName, #profileUsername').forEach(e=>e.textContent=username);
  document.getElementById('profileEmail').textContent = user.email;
  document.getElementById('joinedDate').textContent = new Date(data.joined?.seconds*1000 || data.joined).toLocaleDateString('uz-UZ');
  document.getElementById('link').textContent = location.origin + "/daromad/click.html?u=" + username;
  document.getElementById('cardNumber').value = data.cardNumber ? data.cardNumber.replace(/(\d{4})/g, '$1 ').trim() : "";

  pubRef.onSnapshot(doc => {
    const d = doc.data();
    document.getElementById('totalClicks').textContent = (d.clicks||0).toLocaleString();
    const earn = (d.earnings||0).toFixed(2);
    document.getElementById('totalEarn').textContent = "$"+earn;
    document.getElementById('balance').textContent = "$"+earn;

    const pending = (d.requests || []).some(r => r.status === 'pending');
    hasPendingRequest = pending;
    const btn = document.getElementById('requestPayout');
    const notice = document.getElementById('pendingNotice');
    if(pending || earn < 5){
      btn.disabled = true;
      btn.textContent = pending ? "Kutilyapti..." : "Minimum $5";
      notice.style.display = pending ? "block" : "none";
    } else {
      btn.disabled = false;
      btn.textContent = "So‘rash";
      notice.style.display = "none";
    }

    // Charts
    const daily = d.dailyStats || {};
    const dates = Object.keys(daily).sort().slice(-7);
    const labels = dates.length ? dates.map(d => d.slice(5)) : ["Bugun"];
    const clicksData = dates.length ? dates.map(d => daily[d]?.clicks || 0) : [0];
    if(dailyChart) dailyChart.destroy();
    if(earningsChart) earningsChart.destroy();
    dailyChart = new Chart(document.getElementById('dailyChart'), {type:'bar',data:{labels,datasets:[{label:'Bosishlar',data:clicksData,backgroundColor:'#4361ee'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
    earningsChart = new Chart(document.getElementById('earningsChart'), {type:'line',data:{labels:['Yan','Fev','Mar','Apr','May','Iyun','Iyul','Avg','Sen','Okt','Noy','Dek'],datasets:[{label:'Daromad',data:Array(12).fill(0).map((_,i)=>i+1===new Date().getMonth()+1?parseFloat(earn):0),borderColor:'#10b981',tension:0.4,fill:true}]},options:{responsive:true}});

    const tbody = document.getElementById('payoutTable');
    tbody.innerHTML = '';
    (d.requests||[]).forEach(r => {
      const tr = document.createElement('tr');
      const date = new Date(r.date?.seconds*1000 || r.date);
      tr.innerHTML = `<td>${date.toLocaleDateString()}</td><td>$${r.amount.toFixed(2)}</td><td><strong style="color:${r.status==='paid'?'#10b981':'#f59e0b'}">${r.status==='paid'?'To‘landi':'Kutilyapti'}</strong></td>`;
      tbody.appendChild(tr);
    });
  });

  document.getElementById('requestPayout').onclick = async () => {
    if(hasPendingRequest) return alert("Sizda allaqachon so‘rov bor!");
    const earn = parseFloat(document.getElementById('balance').textContent.replace('$',''));
    if(earn < 5) return alert("Minimum $5 kerak");
    if(confirm(`$${earn.toFixed(2)} so‘raymizmi?`)){
      await pubRef.update({requests: firebase.firestore.FieldValue.arrayUnion({amount:earn,date:new Date(),status:'pending'})});
      alert("So‘rov yuborildi!");
    }
  };
});

window.payUser = async (uid) => {
  if(!confirm("To‘lov tasdiqlansinmi?")) return;
  const ref = db.collection("publishers").doc(uid);
  const data = (await ref.get()).data();
  const updated = (data.requests || []).map(r => r.status === 'pending' ? {...r, status:'paid'} : r);
  await ref.update({requests: updated, earnings: 0, clicks: 0});
  alert("To‘lov amalga oshirildi!");
};

function filterUsers(){
  const term = document.getElementById('userSearch').value.toLowerCase();
  document.querySelectorAll('#usersBody tr').forEach(tr => {
    tr.style.display = tr.textContent.toLowerCase().includes(term) ? '' : 'none';
  });
}

document.getElementById('loginBtn').onclick = () => {
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('pass').value;
  if(!email||!pass) return document.getElementById('error').textContent = "To‘ldiring";
  auth.signInWithEmailAndPassword(email, pass).catch(e=>document.getElementById('error').textContent = e.message);
};

document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => showSection(item.dataset.section));
});
</script>
</body>
</html>

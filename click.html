<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Yo‘naltirilmoqda...</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body{background:#4361ee;color:#fff;font-family:system-ui;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;text-align:center;padding:20px;}
    .spin{border:6px solid rgba(255,255,255,.3);border-top:6px solid #fff;border-radius:50%;width:50px;height:50px;animation:s 1s linear infinite;margin:20px 0;}
    @keyframes s{to{transform:rotate(360deg)}}
    .msg{font-size:18px;line-height:1.6;max-width:90%;}
  </style>
</head>
<body>
  <h2>Bir soniya...</h2>
  <div class="spin"></div>
  <div class="msg" id="msg"><strong>$0.001</strong> hisobingizga qo‘shildi!</div>

<script>
const firebaseConfig = {apiKey:"AIzaSyDoHvJKLk_8QEm0nUN1fWi_lBtGq0nErdA",authDomain:"daromad-link.firebaseapp.com",projectId:"daromad-link",storageBucket:"daromad-link.firebasestorage.app",messagingSenderId:"770178829456",appId:"1:770178829456:web:00ee4ed46d4b4b6bb15c15"};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const SPONSORS = [
  "https://summage.org/blogs/blog1.html",
  "https://summage.org/blogs/blog2.html",
  "https://summage.org/blogs/blog3.html",
  "https://summage.org/blogs/blog4.html",
  "https://summage.org/blogs/blog5.html",
  "https://summage.org/blogs/blog6.html",
  "https://summage.org/blogs/blog7.html",
  "https://summage.org/blogs/blog8.html",
  "https://summage.org/blogs/blog9.html",
  "https://summage.org/blogs/blog10.html",
  "https://summage.org/blogs/blog11.html",
  "https://summage.org/blogs/blog12.html",
  "https://summage.org/blogs/blog13.html"
];
  
const urlParams = new URLSearchParams(location.search);
let username = urlParams.get('u')?.trim();

if (!username || username.length < 3) {
  setTimeout(redirect, 1000);
}

// Har qanday xato bo‘lsa ham redirect bo‘lishi uchun
function redirect() {
  location.href = SPONSORS[Math.floor(Math.random() * SPONSORS.length)];
}

function show(text) {
  document.getElementById("msg").innerHTML = text;
}

// BOSHIDAN ASINXRON KOD
(async () => {
  let realIP = "unknown";
  try {
    const r = await fetch("https://api.ipify.org");
    realIP = await r.text();
  } catch(e) {}

  const today = new Date().toISOString().split('T')[0];
  const now = Date.now();
  const tomorrow = now + 24*60*60*1000;

  try {
    const userSnap = await db.collection("publishers").where("username", "==", username).limit(1).get();
    if (userSnap.empty) throw "user not found";

    const userRef = userSnap.docs[0].ref;
    const userData = (await userRef.get()).data();

    // 1000 klik limit
    const todayClicks = userData?.dailyStats?.[today]?.clicks || 0;
    if (todayClicks >= 1000) {
      show("Bugungi maksimal limitga yetdingiz.<br>Ertaga yana davom etamiz");
      return setTimeout(redirect, 4000);
    }

    const ipRef = db.collection("ip_limits").doc(realIP);
    const ipSnap = await ipRef.get();
    let ipData = ipSnap.exists ? ipSnap.data() : {};

    // Agar 24 soat o‘tgan bo‘lsa – reset
    if (ipData.expiresAt && ipData.expiresAt < now) {
      await ipRef.delete();
      ipData = {};
    }

    const count = ipData.count || 0;
    const last = ipData.lastClick || 0;
    const timeDiff = now - last;

    // 5 daqiqa kutish
    if (count > 0 && timeDiff < 5*60*1000) {
      const min = Math.ceil((5*60*1000 - timeDiff)/60000);
      show(`Yaqinda bosgansiz.<br>Yana <strong>${min} daqiqa</strong>dan keyin`);
      return setTimeout(redirect, 4000);
    }

    // 30 ta IP limit
    if (count >= 30) {
      show("Bugun bu qurilmadan yetarlicha bosildi.<br>Ertaga yana birga");
      return setTimeout(redirect, 4000);
    }

    // HAMMA OK → PUL BERAMIZ
    await db.runTransaction(async t => {
      t.update(userRef, {
        clicks: firebase.firestore.FieldValue.increment(1),
        earnings: firebase.firestore.FieldValue.increment(0.001),
        [`dailyStats.${today}.clicks`]: firebase.firestore.FieldValue.increment(1)
      });
      t.set(ipRef, {
        count: count + 1,
        lastClick: now,
        expiresAt: tomorrow
      }, {merge: true});
    });

    show("<strong>$0.001</strong> hisobingizga qo‘shildi!");
    setTimeout(redirect, 1200);

  } catch (err) {
    // Har qanday xato bo‘lsa ham — redirect qilamiz, foydalanuvchi hech qachon to‘xtab qolmaydi
    console.log(err);
    show("Xatolik yuz berdi, lekin yo‘naltirilmoqda...");
    setTimeout(redirect, 2000);
  }
})();
</script>
</body>
</html>

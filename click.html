<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Yo‘naltirilmoqda...</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body{background:#4361ee;color:#fff;font-family:system-ui;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;text-align:center;padding:20px;}
    .spin{border:6px solid #fff3;border-top:6px solid #fff;border-radius:50%;width:50px;height:50px;animation:s 1s linear infinite;margin:20px 0;}
    @keyframes s{to{transform:rotate(360deg)}}
    .msg{margin-top:15px;font-size:14px;line-height:1.5;}
  </style>
</head>
<body>
  <h2>Bir soniya...</h2>
  <div class="spin"></div>
  <div class="msg" id="msg"><strong>$0.001</strong> hisobingizga qo‘shildi!</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDoHvJKLk_8QEm0nUN1fWi_lBtGq0nErdA",
  authDomain: "daromad-link.firebaseapp.com",
  projectId: "daromad-link",
  storageBucket: "daromad-link.firebasestorage.app",
  messagingSenderId: "770178829456",
  appId: "1:770178829456:web:00ee4ed46d4b4b6bb15c15",
  databaseURL: "https://daromad-link-default-rtdb.firebaseio.com"   // ← FIXED REGION
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const rtdb = firebase.database();

const params = new URLSearchParams(location.search);
let username = params.get('u') || '';
if (!username || username.length < 3) {
  redirect();
}

let userIP = "unknown";

fetch('https://api.ipify.org?format=json')
  .then(r => r.json())
  .then(j => { userIP = (j.ip || "noip").replace(/\./g, '_'); }) // ← REPLACE DOTS WITH UNDERSCORES
  .catch(() => userIP = "noip")
  .finally(() => processClick());

function processClick() {
  const ipRef = rtdb.ref(`clicks/${userIP}`);
  const now = Date.now();
  const threeHours = 3 * 60 * 60 * 1000;

  ipRef.once('value')
    .then(snap => {
      const data = snap.val();

      if (!data || (now - data.lastClick) > threeHours) {
        // VALID CLICK → add money
        db.collection("publishers")
          .where("username", "==", username)
          .limit(1)
          .get()
          .then(q => {
            if (!q.empty) {
              const ref = q.docs[0].ref;
              const today = new Date().toISOString().split('T')[0];
              ref.update({
                clicks: firebase.firestore.FieldValue.increment(1),
                earnings: firebase.firestore.FieldValue.increment(0.001),
                [`dailyStats.${today}.clicks`]: firebase.firestore.FieldValue.increment(1)
              });
            }
          })
          .finally(() => {
            ipRef.set({ lastClick: now });
            document.getElementById("msg").innerHTML = "<strong>$0.001</strong> hisobingizga qo‘shildi!";
            redirect();
          });

      } else {
        const minsLeft = Math.ceil((threeHours - (now - data.lastClick)) / 60000);
        document.getElementById("msg").innerHTML = `Oxirgi 3 soatda bosgansiz<br>Keyingi bosish: <strong>${minsLeft} daqiqa</strong> dan keyin`;
        setTimeout(redirect, 2500);
      }
    })
    .catch(err => {
      console.error(err);
      redirect(); // even if something fails, still redirect
    });
}

const SPONSORS = [
  "https://summage.org/blogs/blog1.html",
  "https://summage.org/blogs/blog2.html",
  "https://summage.org/blogs/blog3.html"
];

function redirect() {
  setTimeout(() => location.href = SPONSORS[Math.floor(Math.random() * SPONSORS.length)], 1200);
}
</script>
</body>
</html>

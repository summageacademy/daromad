<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Yo‘naltirilmoqda...</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body{background:#4361ee;color:#fff;font-family:system-ui;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;text-align:center;padding:20px;}
    .spin{border:6px solid rgba(255,255,255,.3);border-top:6px solid #fff;border-radius:50%;width:50px;height:50px;animation:s 1s linear infinite;margin:20px 0;}
    @keyframes s{to{transform:rotate(360deg)}}
    .msg{font-size:18px;line-height:1.6;max-width:90%;}
  </style>
</head>
<body>
  <h2>Bir soniya...</h2>
  <div class="spin"></div>
  <div class="msg" id="msg"><strong>$0.001</strong> hisobingizga qo‘shildi!</div>

<script>
const firebaseConfig = {apiKey:"AIzaSyDoHvJKLk_8QEm0nUN1fWi_lBtGq0nErdA",authDomain:"daromad-link.firebaseapp.com",projectId:"daromad-link",storageBucket:"daromad-link.firebasestorage.app",messagingSenderId:"770178829456",appId:"1:770178829456:web:00ee4ed46d4b4b6bb15c15"};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const SPONSORS = ["https://summage.org/blogs/blog1.html","https://summage.org/blogs/blog2.html","https://summage.org/blogs/blog3.html"];
const urlParams = new URLSearchParams(location.search);
let username = urlParams.get('u')?.trim();

if (!username || username.length < 3) {
  setTimeout(() => location.href = SPONSORS[Math.floor(Math.random() * SPONSORS.length)], 1000);
  throw new Error("No username");
}

function redirect() {
  location.href = SPONSORS[Math.floor(Math.random() * SPONSORS.length)];
}

function show(text) {
  document.getElementById("msg").innerHTML = text;
}

(async () => {
  let realIP = "unknown";
  try {
    const r = await fetch("https://api.ipify.org");
    realIP = await r.text();
  } catch(e) {}

  const today = new Date().toISOString().split('T')[0];
  const now = Date.now();
  const tomorrow = now + 24*60*60*1000;

  try {
    const userSnap = await db.collection("publishers").where("username", "==", username).limit(1).get();
    if (userSnap.empty) throw "user not found";

    const userRef = userSnap.docs[0].ref;
    const ipRef = db.collection("ip_limits").doc(realIP);

    // BITTA TRANSACTION — HAMMA TEKSHIRUV VA YOZISH SHU YERDA
    await db.runTransaction(async (t) => {
      const userDoc = await t.get(userRef);
      if (!userDoc.exists) throw "user gone";

      const data = userDoc.data();
      const todayClicks = data.dailyStats?.[today]?.clicks || 0;

      // 1000 LIMIT — ENDI HECH QACHON O‘TMAYDI
      if (todayClicks >= 1000) {
        show("Bugungi maksimal limitga yetdingiz.<br>Ertaga yana davom etamiz");
        setTimeout(redirect, 4000);
        return; // transaction to‘xtaydi
      }

      // IP tekshiruvi
      const ipDoc = await t.get(ipRef);
      let ipData = ipDoc.exists ? ipDoc.data() : {};

      // 24 soat o‘tgan bo‘lsa o‘chir
      if (ipData.expiresAt && ipData.expiresAt < now) {
        t.delete(ipRef);
        ipData = {count: 0, lastClick: 0};
      }

      const count = ipData.count || 0;
      const lastClick = ipData.lastClick || 0;
      const timeDiff = now - lastClick;

      // 5 daqiqa kutish
      if (count > 0 && timeDiff < 5*60*1000) {
        const minLeft = Math.ceil((5*60*1000 - timeDiff) / 60000);
        show(`Yaqinda bosgansiz.<br>Yana <strong>${minLeft} daqiqa</strong> kutish kerak`);
        setTimeout(redirect, 4000);
        return;
      }

      // 30 ta IP limit
      if (count >= 30) {
        show("Bugun bu qurilmadan yetarlicha bosildi.<br>Ertaga yana birga");
        setTimeout(redirect, 4000);
        return;
      }

      // HAMMA TEKSHIRUVDAN O‘TDI → PUL BERAMIZ
      t.update(userRef, {
        clicks: firebase.firestore.FieldValue.increment(1),
        earnings: firebase.firestore.FieldValue.increment(0.001),
        [`dailyStats.${today}.clicks`]: firebase.firestore.FieldValue.increment(1)
      });

      t.set(ipRef, {
        count: count + 1,
        lastClick: now,
        expiresAt: tomorrow
      }, {merge: true});

    }); // transaction tugadi

    // Agar bu yerga yetib kelsa — pul muvaffaqiyatli qo‘shildi
    show("<strong>$0.001</strong> hisobingizga qo‘shildi!");
    setTimeout(redirect, 1200);

  } catch (err) {
    console.log("Error:", err);
    show("Xatolik yuz berdi, lekin yo‘naltirilmoqda...");
    setTimeout(redirect, 2000);
  }
})();
</script>
</body>
</html>
